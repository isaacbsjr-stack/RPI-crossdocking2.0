<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Etiqueta 100x50mm</title>
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    .etiqueta {
      width: 100mm; height: 50mm; border: 1px solid #000;
      display: flex; flex-direction: row; background: #fff; box-sizing: border-box;
    }
    .chave {
      width: 40%; display: flex; align-items: center; justify-content: center;
      background: #000; color: #fff; font-weight: bold; font-size: 48pt;
      border-right: 1px solid #000; text-align: center;
    }
    .info {
      width: 60%; padding: 3mm; display: flex; flex-direction: column;
      justify-content: space-between; font-size: 10pt;
    }
    .info .destinatario { font-weight: normal; font-size: 12pt; margin-bottom: 1mm; }
    .info .cidade-bairro-estado,
    .info .endereco,
    .info .bairro-estado {
      font-size: 9pt;
      margin-bottom: 1mm;
    }
    .info .detalhes { font-size: 10pt; display: flex; flex-direction: column; gap: 1mm; }
    .info .codigo-produto { font-weight: bold; }
    .bloco-espaco { height: 3mm; }
  </style>
</head>
<body>
  <div id="conteudoEtiqueta"></div>
  <script>
  const entrega = JSON.parse(localStorage.getItem("dadosEtiqueta"));
  // Função para imprimir usando a impressora padrão ou selecionada
  function imprimirEtiqueta() {
    // Verifica se já existe configuração de impressora
    const impressoraSalva = localStorage.getItem("impressoraEtiqueta");
    if (!impressoraSalva) {
      // Exibe diálogo de seleção de impressora (nativo do navegador)
      window.print();
      // Após a primeira impressão, salva um flag para não mostrar novamente
      localStorage.setItem("impressoraEtiqueta", "padrao");
    } else {
      // Imprime direto sem mostrar seleção
      window.print();
    }
    setTimeout(() => window.close(), 500);
  }

  if (!entrega) {
    document.body.innerHTML = "<h2>Dados da etiqueta não encontrados.</h2>";
  } else {
    const destinatario = entrega["Destinatário Nome"];
    const endereco = `${entrega["Destinatário Endereço"]}, ${entrega["Destinatário Endereço Número"]}`;
    const bairro = entrega["Destinatario Bairro"];
    const cidade = entrega["Destinatario Cidade"];
    const estado = entrega["Destinatario Estado"];
    const notaFiscal = entrega["Nº da Nota Fiscal"];
    const codigoProduto = entrega["Codigo do produto"];
    const sequencia = entrega["Sequencia"];
    const chave = entrega.chave;
    const dataHora = new Date().toLocaleString();

    document.getElementById("conteudoEtiqueta").innerHTML = `
      <div class="etiqueta">
        <div class="chave">${chave}</div>
        <div class="info">
          <div class="destinatario">${destinatario}</div>
          <div class="cidade-bairro-estado">${cidade} - ${bairro} - ${estado}</div>
          <div class="endereco">${endereco}</div>
          <div class="bloco-espaco"></div>
          <div class="detalhes">
            <div>Seq.: ${sequencia}</div>
            <div>NF: ${notaFiscal}</div>
            <div class="codigo-produto">Código: ${codigoProduto}</div>
            <div>Data/Hora: ${dataHora}</div>
          </div>
        </div>
      </div>
    `;
    window.onload = imprimirEtiqueta;
  }
  </script>
</body>
</html>
